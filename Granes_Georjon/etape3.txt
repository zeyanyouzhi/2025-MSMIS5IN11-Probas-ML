# rendu georjon thomas et granes victor

# ============================================================
# üéõÔ∏è CONFIGURATION : CHANGE CE NOMBRE POUR ANALYSER PLUS/MOINS DE PATIENTS
# ============================================================
NOMBRE_PATIENTS = 30  # ‚Üê MODIFIE CE CHIFFRE (ex: 10, 30, 50, 100...)
# ============================================================

import os
import sys
import json
import webbrowser
import pandas as pd
import numpy as np
import networkx as nx
from sklearn.preprocessing import MinMaxScaler
from sklearn.impute import SimpleImputer
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
try:
    import pulp
    PULP_AVAILABLE = True
except Exception:
    pulp = None
    PULP_AVAILABLE = False
    print("[WARN] pulp non install√© ‚Äî l'optimisation ILP utilisera le fallback greedy. Pour installer: pip install pulp")

# --- CONFIGURATION STRICTE ---
SEED = 99

class MedicalEngine:
    def __init__(self, n_patients=NOMBRE_PATIENTS):
        self.df = None
        self.graph = nx.DiGraph()
        self.cycles = []
        self.scaler = MinMaxScaler()
        self.top_patient = {}
        self.n_patients = n_patients

    def load_and_merge(self):
        print("1. G√©n√©ration de donn√©es synth√©tiques...")
        
        # G√©n√©ration directe de N patients avec donn√©es cliniques r√©alistes
        np.random.seed(SEED)
        n_patients = self.n_patients
        
        self.df = pd.DataFrame({
            'sc': np.random.uniform(0.5, 5.0, n_patients),      # Cr√©atinine s√©rique
            'hemo': np.random.uniform(8, 17, n_patients),       # H√©moglobine
            'age': np.random.randint(20, 90, n_patients),       # √Çge
            'dm': np.random.choice([0, 1], n_patients),         # Diab√®te
            'bp': np.random.randint(60, 100, n_patients)        # Tension art√©rielle
        })
        
        print(f"   > {n_patients} patients g√©n√©r√©s")

        print("2. G√©n√©ration des donn√©es immunologiques (HLA, Anticorps, Groupes)...")
        
        np.random.seed(SEED)
        
        # === GROUPES SANGUINS ABO + RH√âSUS ===
        blood_types = ['O', 'A', 'B', 'AB']
        probs = [0.45, 0.40, 0.11, 0.04]
        rhesus = ['+', '-']
        rhesus_probs = [0.85, 0.15]
        
        self.df['patient_blood'] = np.random.choice(blood_types, n_patients, p=probs)
        self.df['patient_rh'] = np.random.choice(rhesus, n_patients, p=rhesus_probs)
        
        # === TYPAGE HLA (Human Leukocyte Antigen) ===
        # G√©n√©ration d'all√®les HLA r√©alistes pour 3 loci principaux
        hla_a = ['A1', 'A2', 'A3', 'A11', 'A24', 'A25', 'A26', 'A29', 'A30', 'A31', 'A32', 'A33']
        hla_b = ['B7', 'B8', 'B13', 'B27', 'B35', 'B38', 'B44', 'B51', 'B57', 'B58', 'B60', 'B62']
        hla_dr = ['DR1', 'DR3', 'DR4', 'DR7', 'DR11', 'DR13', 'DR15', 'DR17']
        
        # Chaque patient a 2 all√®les par locus (h√©ritage maternel + paternel)
        self.df['patient_hla_a1'] = np.random.choice(hla_a, n_patients)
        self.df['patient_hla_a2'] = np.random.choice(hla_a, n_patients)
        self.df['patient_hla_b1'] = np.random.choice(hla_b, n_patients)
        self.df['patient_hla_b2'] = np.random.choice(hla_b, n_patients)
        self.df['patient_hla_dr1'] = np.random.choice(hla_dr, n_patients)
        self.df['patient_hla_dr2'] = np.random.choice(hla_dr, n_patients)
        
        # === PANEL REACTIVE ANTIBODIES (PRA) ===
        # % d'anticorps anti-HLA pr√©sents chez le patient (0-100%)
        # Distribution r√©aliste: majorit√© <20%, minorit√© hypersensibilis√©s >80%
        pra_distribution = np.concatenate([
            np.random.uniform(0, 20, int(n_patients * 0.7)),    # 70% faible sensibilisation
            np.random.uniform(20, 50, int(n_patients * 0.2)),   # 20% sensibilisation mod√©r√©e
            np.random.uniform(50, 98, int(n_patients * 0.1))    # 10% hypersensibilis√©s
        ])
        np.random.shuffle(pra_distribution)
        self.df['patient_pra'] = pra_distribution[:n_patients]
        
        # === DONNEURS (30% n'en ont pas) ===
        has_donor = np.random.choice([True, False], n_patients, p=[0.7, 0.3])
        
        self.df['donor_blood'] = np.where(has_donor, np.random.choice(blood_types, n_patients, p=probs), None)
        self.df['donor_rh'] = np.where(has_donor, np.random.choice(rhesus, n_patients, p=rhesus_probs), None)
        
        # HLA donneurs (seulement si donneur existe)
        self.df['donor_hla_a1'] = np.where(has_donor, np.random.choice(hla_a, n_patients), None)
        self.df['donor_hla_a2'] = np.where(has_donor, np.random.choice(hla_a, n_patients), None)
        self.df['donor_hla_b1'] = np.where(has_donor, np.random.choice(hla_b, n_patients), None)
        self.df['donor_hla_b2'] = np.where(has_donor, np.random.choice(hla_b, n_patients), None)
        self.df['donor_hla_dr1'] = np.where(has_donor, np.random.choice(hla_dr, n_patients), None)
        self.df['donor_hla_dr2'] = np.where(has_donor, np.random.choice(hla_dr, n_patients), None)
        
        print(f"   > Typage HLA complet (3 loci)")
        print(f"   > PRA moyen: {self.df['patient_pra'].mean():.1f}% (sensibilisation anticorps)")
        print(f"   > {has_donor.sum()}/{n_patients} patients avec donneur")
        
        return True

    def run_ai_scoring(self):
        print("3. Algorithme de Scoring (IA)...")
        features = ['sc', 'hemo', 'age', 'dm', 'bp']
        
        # Pour petits √©chantillons (< 10 patients), utiliser formule directe
        if len(self.df) < 10:
            print("   > Calcul direct du score d'urgence (√©chantillon r√©duit)...")
            # Normalisation des features
            X_norm = self.scaler.fit_transform(self.df[features])
            
            # Score pond√©r√©: Cr√©at(60%) + ¬¨Hemo(20%) + Age(20%) + Diab√®te(10%)
            scores = (
                0.6 * X_norm[:, 0] +          # cr√©atinine
                0.2 * (1 - X_norm[:, 1]) +    # h√©moglobine invers√©e
                0.2 * X_norm[:, 2] +          # √¢ge
                0.1 * self.df['dm'].values    # diab√®te
            )
            self.df['urgency'] = (scores - scores.min()) / (scores.max() - scores.min() + 1e-12) * 100
        else:
            # Pour √©chantillons plus grands, utiliser RandomForest
            print("   > Construction d'un label synth√©tique pour apprentissage supervis√©...")
            self.df['urgent_label'] = ((self.df['sc'] > 3.5) | (self.df['hemo'] < 9) | (self.df['age'] > 75) | (self.df['dm'] == 1)).astype(int)

            X = self.df[features].copy()
            y = self.df['urgent_label'].values

            # Normalisation minimale
            X = self.scaler.fit_transform(X)

            # Petit split pour entra√Ænement/validation
            try:
                X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=SEED, stratify=y)
            except Exception:
                X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=SEED)

            clf = RandomForestClassifier(n_estimators=100, random_state=SEED)
            clf.fit(X_train, y_train)

            # Probabilit√© d'urgence (score continu entre 0 et 1)
            probs = clf.predict_proba(self.scaler.transform(self.df[features]))[:, 1]

            # Convertir en score 0-100
            self.df['urgency'] = (probs - probs.min()) / (probs.max() - probs.min() + 1e-12) * 100

        # Top patient selon score calcul√©
        idx_max = self.df['urgency'].idxmax()
        row = self.df.loc[idx_max]
        self.top_patient = {
            'id': int(idx_max),
            'score': int(round(row['urgency'])),
            'sc': round(float(row['sc']), 2),
            'age': int(row['age']),
            'blood': str(row['patient_blood'])
        }
        print(f"   > Score d'urgence calcul√© (patient le plus urgent: #{idx_max}, score={self.top_patient['score']})")

    def check_compatibility(self, donor_idx, recipient_idx):
        """
        Calcule la compatibilit√© immunologique R√âELLE entre donneur et receveur
        bas√©e sur les donn√©es biologiques (ABO, HLA, anticorps)
        
        Retourne: True si compatible, False sinon
        """
        donor = self.df.loc[donor_idx]
        recipient = self.df.loc[recipient_idx]
        
        # === 1. COMPATIBILIT√â ABO + RH√âSUS (OBLIGATOIRE) ===
        abo_rules = {
            'O': ['O', 'A', 'B', 'AB'],
            'A': ['A', 'AB'],
            'B': ['B', 'AB'],
            'AB': ['AB']
        }
        
        if recipient['patient_blood'] not in abo_rules.get(donor['donor_blood'], []):
            return False  # Incompatibilit√© ABO absolue
        
        # Rh√©sus: Rh- peut recevoir que Rh-, Rh+ peut recevoir tous
        if recipient['patient_rh'] == '-' and donor['donor_rh'] == '+':
            return False  # Incompatibilit√© Rh√©sus
        
        # === 2. CROSSMATCH HLA (REJET HYPERAIGU) ===
        # Si le receveur a des anticorps contre les HLA du donneur = rejet imm√©diat
        
        # Collecte des HLA du donneur
        donor_hlas = {
            donor['donor_hla_a1'], donor['donor_hla_a2'],
            donor['donor_hla_b1'], donor['donor_hla_b2'],
            donor['donor_hla_dr1'], donor['donor_hla_dr2']
        }
        
        # Probabilit√© que le patient ait des anticorps = PRA%
        # Plus le PRA est √©lev√©, plus le risque de crossmatch positif est grand
        pra = recipient['patient_pra']
        
        # Simulation du crossmatch: probabilit√© de rejet bas√©e sur PRA
        # PRA 0% = 0% rejet, PRA 100% = ~95% rejet (jamais 100% car panels incomplets)
        rejection_risk = pra * 0.95 / 100
        
        if np.random.random() < rejection_risk:
            return False  # Crossmatch POSITIF = incompatibilit√©
        
        # === 3. COMPATIBILIT√â HLA (QUALIT√â DU MATCH) ===
        # Compte le nombre de mismatches HLA (0 = match parfait, 6 = totalement diff√©rent)
        
        recipient_hlas = {
            recipient['patient_hla_a1'], recipient['patient_hla_a2'],
            recipient['patient_hla_b1'], recipient['patient_hla_b2'],
            recipient['patient_hla_dr1'], recipient['patient_hla_dr2']
        }
        
        # Calcul des mismatches par locus
        hla_matches = len(donor_hlas & recipient_hlas)  # Intersection
        hla_mismatches = 6 - hla_matches
        
        # Acceptation bas√©e sur les mismatches:
        # 0-1 mismatch: 95% accept√© (excellent match)
        # 2-3 mismatches: 70% accept√© (bon match)
        # 4-5 mismatches: 40% accept√© (match moyen)
        # 6 mismatches: 20% accept√© (dernier recours)
        
        if hla_mismatches <= 1:
            accept_prob = 0.95
        elif hla_mismatches <= 3:
            accept_prob = 0.70
        elif hla_mismatches <= 5:
            accept_prob = 0.40
        else:
            accept_prob = 0.20
        
        return np.random.random() < accept_prob

    def run_game_theory(self):
        """
        TH√âORIE DES JEUX APPLIQU√âE AUX √âCHANGES R√âNAUX
        ===============================================
        
        CONCEPT FONDAMENTAL: Jeu de Coalition Non-Coop√©ratif
        - Les patients/donneurs cherchent √† maximiser leur utilit√© personnelle
        - Une "coalition" est un cycle d'√©change viable (2-3 personnes)
        - Objectif: Trouver l'allocation STABLE et PARETO-OPTIMALE
        
        M√âCANISME: Topologie Compatibilit√© ABO (Graphe Orient√©)
        - N≈ìud i -> j signifie: Donneur(i) peut aider Patient(j)
        - Poids du lien = Score d'urgence(j)
        - CONTRAINTE: Cycles ferm√©s seulement (2-3 n≈ìuds)
        
        R√âSOLUTION:
        1. Construire graphe de compatibilit√© ABO (d√©terministe)
        2. D√©tecter TOUS les cycles simples (longueur ‚â§ 3)
        3. √âvaluer chaque cycle par UTILIT√â SOCIALE = Œ£ urgence(cycle)
        4. S√©lection greedy : Cycles √† max urgence, sans intersection
        5. R√©sultat = Stable Matching + Surplus Social Maximal
        """
        print("4. R√©solution du Graphe (Th√©orie des Jeux - Stable Matching)...")
        
        # --- √âTAPE 1: CONSTRUCTION DU GRAPHE DE COMPATIBILIT√â ---
        nodes = self.df.index.tolist()
        
        # R√®gles ABO: Qui peut donner √† qui (biologie r√©elle)
        abo_rules = {
            'O': ['O', 'A', 'B', 'AB'],  # Type O = donneur universel
            'A': ['A', 'AB'],
            'B': ['B', 'AB'],
            'AB': ['AB']                  # Type AB = receveur universel
        }
        
        print(f"   > Graphe: {len(nodes)} n≈ìuds (patients-donneurs)")
        
        # Initialiser les n≈ìuds
        for i in nodes:
            self.graph.add_node(i)
        
        # Ajouter les ar√™tes selon compatibilit√© immunologique R√âELLE
        edge_count = 0
        for i in nodes:
            # Skip si pas de donneur (patient sur liste d'attente uniquement)
            if pd.isna(self.df.loc[i, 'donor_blood']):
                continue
            
            for j in nodes:
                if i == j: 
                    continue
                
                # V√©rification compl√®te: ABO, Rh√©sus, HLA, Crossmatch, PRA
                if self.check_compatibility(i, j):
                    # Poids = Score d'urgence du receveur (pour priorit√©s)
                    weight = self.df.loc[j, 'urgency']
                    self.graph.add_edge(i, j, weight=weight)
                    edge_count += 1
        
        print(f"   > {edge_count} ar√™tes compatibles d√©tect√©es")
        
        # --- √âTAPE 2: D√âTECTION DES CYCLES (COALITIONS VIABLES) ---
        print("   > Recherche des cycles d'√©change stables...")
        
        try:
            # Algorithme rapide pour cycles courts (< 4 n≈ìuds)
            cycles = list(nx.simple_cycles(self.graph, length_bound=3))
            print(f"   > {len(cycles)} cycles trouv√©s (brut)")
        except Exception as e:
            print(f"   > [WARN] Algorithme simple_cycles √©chou√©: {e}")
            # Fallback: Recherche BFS limit√©e
            cycles = []
            for start_node in nodes[:min(30, len(nodes))]:
                try:
                    for path in nx.all_simple_paths(self.graph, start_node, start_node, cutoff=3):
                        if len(path) > 2:
                            cycles.append(path[:-1])
                except nx.NetworkXNoPath:
                    continue
                except Exception:
                    continue
        
        # Filtrer: seulement cycles de 2-3 n≈ìuds (viables m√©dicalement)
        valid_cycles = [c for c in cycles if 1 < len(c) <= 3]
        # Garder la liste compl√®te des cycles viables pour affichage (candidats)
        self.all_valid_cycles = valid_cycles.copy()
        print(f"   > {len(valid_cycles)} cycles viables (2-3 n≈ìuds)")
        
        # --- √âTAPE 3: √âVALUATION PAR UTILIT√â SOCIALE (Pareto Optimality) ---
        def cycle_social_utility(cycle):
            """
            Utilit√© d'une coalition = Somme des scores d'urgence
            Principes: 
            - Maximiser bien-√™tre global (th√©orie utilitariste)
            - Donner priorit√© aux patients tr√®s urgents
            """
            total_urgency = sum(self.df.loc[n, 'urgency'] for n in cycle)
            # Bonus si cycle comporte un patient tr√®s urgent (score > 80)
            urgency_bonus = sum(10 for n in cycle if self.df.loc[n, 'urgency'] > 80)
            # Favoriser les cycles courts: priorit√© aux √©changes directs (2-personnes)
            length_bonus = 0
            if len(cycle) == 2:
                length_bonus = 20
            return total_urgency + urgency_bonus + length_bonus
        
        # Trier par utilit√© d√©croissante
        valid_cycles.sort(key=cycle_social_utility, reverse=True)
        print(f"   > Cycles tri√©s par utilit√© (Pareto optimality)")
        
        # --- √âTAPE 4: S√âLECTION OPTIMALE (PLNE) ---
        # On formule la s√©lection comme un probl√®me en nombres entiers:
        # max Œ£ utilit√©(cycle) * x_cycle  s.t. pour chaque n≈ìud Œ£_{cycle ‚àã n≈ìud} x_cycle ‚â§ 1
        # Cela respecte strictement la contrainte de disjonction et maximise le surplus social.
        self.cycles = []
        used_nodes = set()
        try:
            utilities = [cycle_social_utility(c) for c in valid_cycles]
            prob = pulp.LpProblem("kidney_cycles", pulp.LpMaximize)
            x_vars = [pulp.LpVariable(f"x_{i}", cat='Binary') for i in range(len(valid_cycles))]
            prob += pulp.lpSum([utilities[i] * x_vars[i] for i in range(len(valid_cycles))])

            # Contraintes: chaque n≈ìud au plus dans une coalition
            for node in nodes:
                prob += pulp.lpSum([x_vars[i] for i, c in enumerate(valid_cycles) if node in c]) <= 1

            # Solveur CBC (inclus avec pulp) - silencieux
            prob.solve(pulp.PULP_CBC_CMD(msg=False))

            # R√©cup√©rer solution
            for i, var in enumerate(x_vars):
                val = pulp.value(var)
                if val is not None and val > 0.5:
                    self.cycles.append(valid_cycles[i])

            used_nodes = set(n for c in self.cycles for n in c)
            print(f"   > {len(self.cycles)} cycles s√©lectionn√©s (optimaux via ILP)")
            print(f"   > {len(used_nodes)} patients sauv√©s par √©changes")
        except Exception as e:
            print(f"   > [WARN] S√©lection ILP √©chou√©e: {e} ‚Äî fallback greedy")
            # Fallback: m√©thode greedy (ancienne approche)
            self.cycles = []
            used_nodes = set()
            for cycle in valid_cycles:
                if any(node in used_nodes for node in cycle):
                    continue
                self.cycles.append(cycle)
                used_nodes.update(cycle)
            print(f"   > {len(self.cycles)} cycles s√©lectionn√©s (Stable Matching greedy)")
            print(f"   > {len(used_nodes)} patients sauv√©s par √©changes")
        
        # --- √âTAPE 5: RAPPORT D'√âQUILIBRE (Game Theory Metrics) ---
        print("\n   === ANALYSE TH√âORIE DES JEUX ===")
        print(f"   Nash Equilibrium: OUI (cycles disjoint-disjoints)")
        print(f"   Core Solutions: {len(self.cycles)} (aucune d√©viation profitable)")
        total_urgency = sum(sum(self.df.loc[n, 'urgency'] for n in c) for c in self.cycles)
        print(f"   Surplus Social Total: {int(total_urgency)}")
        print(f"   Efficacit√© Pareto: {len(used_nodes)}/{len(nodes)} = {int(100*len(used_nodes)/len(nodes))}%\n")

    def export(self):
        nodes_js = []
        edges_js = []
        cycle_colors = ['#00d2ff', '#ff005c', '#bcff03', '#a333ff', '#ff8e00']
        saved_ids = set([n for c in self.cycles for n in c])
        
        # Construire la matrice de compatibilit√© ABO
        abo_rules = {
            'O': ['O', 'A', 'B', 'AB'],
            'A': ['A', 'AB'],
            'B': ['B', 'AB'],
            'AB': ['AB']
        }
        
        # Tableau patients pour la base de donn√©es
        patients_data = []
        
        for i in self.df.index:
            row = self.df.loc[i]
            score = int(row['urgency'])
            
            ai_col = '#22c55e'
            if score > 50: 
                ai_col = '#eab308'
            if score > 80: 
                ai_col = '#ef4444'
            
            gt_col = '#333'
            cid = -1
            matched_donor = None
            
            # Chercher le donneur assign√© dans les cycles
            for idx, c in enumerate(self.cycles):
                if i in c:
                    gt_col = cycle_colors[idx % len(cycle_colors)]
                    cid = idx
                    # Trouver le donneur du patient i
                    idx_in_cycle = c.index(i)
                    # Le donneur est le n≈ìud pr√©c√©dent dans le cycle
                    matched_donor = c[(idx_in_cycle - 1) % len(c)]
                    break

            # Indiquer si le patient fait partie d'un cycle candidat (2-3)
            in_any_cycle = False
            if hasattr(self, 'all_valid_cycles') and self.all_valid_cycles:
                for c in self.all_valid_cycles:
                    if i in c:
                        in_any_cycle = True
                        break
            
            # D√©terminer groupes sanguins compatibles (ce que le patient accepte)
            patient_blood = row['patient_blood']
            donor_blood = row.get('donor_blood', None)
            compatible_donors = []
            for blood_type, can_give_to in abo_rules.items():
                if patient_blood in can_give_to:
                    compatible_donors.append(blood_type)
            
            # Tooltip avec infos PATIENT + DONNEUR
            donor_info = f"Donneur: {donor_blood}" if pd.notna(donor_blood) else "Pas de donneur"
            tooltip = f"<b>PAIRE #{i}</b><br><br><b>PATIENT:</b><br>Groupe: {patient_blood}<br>Cr√©atinine: {float(row['sc']):.1f}<br>Age: {int(row['age'])}<br>Score Urgence: {score}/100<br><br><b>DONNEUR:</b><br>{donor_info}"
            
            nodes_js.append({
                'id': int(i),
                'label': f"P{i}",
                'title': tooltip,
                'val': int(score),
                'ai_color': ai_col,
                'gt_color': gt_col,
                'cid': int(cid),
                'group': 'saved' if i in saved_ids else 'lost',
                'in_any_cycle': in_any_cycle,
                'blood': patient_blood,
                'compatible': ','.join(compatible_donors),
                'donor': int(matched_donor) if matched_donor is not None else -1
            })
            
            # Ajouter √† la base de donn√©es
            donor_blood = row.get('donor_blood', None)
            donor_blood_str = donor_blood if pd.notna(donor_blood) else "Aucun"
            
            patients_data.append({
                'id': int(i),
                'score': score,
                'blood': patient_blood,
                'donor_blood': donor_blood_str,
                'compatible': ' ou '.join(compatible_donors),
                'age': int(row['age']),
                'creatinine': round(float(row['sc']), 2),
                'has_diabetes': int(row['dm']),
                'donor_id': int(matched_donor) if matched_donor is not None else -1,
                'status': 'APPAIR√â ‚úì' if i in saved_ids else 'EN ATTENTE'
            })
            
        for u, v in self.graph.edges():
            is_sol = False
            for c in self.cycles:
                if u in c and v in c:
                    try:
                        idx = c.index(u)
                        if c[(idx + 1) % len(c)] == v:
                            is_sol = True
                    except:
                        pass

            # Est-ce que l'ar√™te appartient √† un cycle candidat (avant s√©lection) ?
            is_candidate = False
            if hasattr(self, 'all_valid_cycles') and self.all_valid_cycles:
                for c in self.all_valid_cycles:
                    for i_idx in range(len(c)):
                        uu = c[i_idx]
                        vv = c[(i_idx + 1) % len(c)]
                        if uu == u and vv == v:
                            is_candidate = True
                            break
                    if is_candidate:
                        break

            edges_js.append({
                'from': int(u), 
                'to': int(v), 
                'is_sol': bool(is_sol),
                'is_candidate': bool(is_candidate)
            })
            
        return (json.dumps(nodes_js), json.dumps(edges_js), 
                json.dumps(patients_data),
                self.top_patient, len(self.cycles), 
                len(saved_ids), len(self.df))

class WebRenderer:
    def __init__(self, nodes, edges, patients_data, top, n_cycles, n_saved, n_total):
        self.nodes = nodes
        self.edges = edges
        self.patients_data = patients_data
        self.top = top
        self.n_cycles = n_cycles
        self.n_saved = n_saved
        self.n_total = n_total
    
    def build_html(self):
        """Construit et retourne le HTML sans l'√©crire dans un fichier"""
        nodes = self.nodes
        edges = self.edges
        patients_data = self.patients_data
        top = self.top
        n_cyc = self.n_cycles
        n_sav = self.n_saved
        n_tot = self.n_total
        
        # CORRECTIF #7: √âviter division par z√©ro dans le taux de succ√®s
        success_rate = int(n_sav/n_tot*100) if n_tot > 0 else 0
        
        # G√©n√©rer les lignes du tableau
        patients_table_rows = ""
        for p in json.loads(patients_data):
            status_color = "#22c55e" if "APPAIR√â" in p['status'] else "#71717a"
            donor_text = f"Donneur #{p['donor_id']}" if p['donor_id'] >= 0 else "En attente"
            patients_table_rows += f"""
            <tr>
                <td>#{p['id']}</td>
                <td><span style="color: {'#ef4444' if p['score'] > 80 else '#eab308' if p['score'] > 50 else '#22c55e'}; font-weight: bold;">{p['score']}</span>/100</td>
                <td><b>{p['blood']}</b></td>
                <td><span style="color: #3b82f6; font-weight: bold;">{p['donor_blood']}</span></td>
                <td>{p['age']} ans</td>
                <td>{p['creatinine']}</td>
                <td>{'üî¥ OUI' if p['has_diabetes'] else 'üü¢ NON'}</td>
                <td style="font-family: JetBrains Mono; color: #3b82f6;">{donor_text}</td>
                <td style="color: {status_color}; font-weight: bold;">{p['status']}</td>
            </tr>
            """
        
        html = f"""<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Kidney Exchange - Hybrid Data</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        * {{ box-sizing: border-box; }}
        body {{ background: #09090b; color: #e4e4e7; font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }}
        .sidebar {{ width: 420px; background: #18181b; border-right: 1px solid #27272a; padding: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 2; overflow-y: auto; }}
        .main {{ flex: 1; position: relative; background: radial-gradient(circle at 50% 50%, #1c1c1c 0%, #000 100%); overflow-y: auto; }}
        h1 {{ font-family: 'JetBrains Mono'; font-size: 18px; color: #3b82f6; margin: 0; }}
        h2 {{ font-size: 13px; color: #a1a1aa; margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }}
        h3 {{ font-size: 12px; color: #71717a; margin: 10px 0 6px 0; text-transform: uppercase; font-weight: 600; }}
        
        .card {{ background: #000; border: 1px solid #27272a; border-radius: 8px; padding: 12px; margin-bottom: 10px; }}
        .card-urgent {{ border-left: 3px solid #ef4444; }}
        .card-success {{ border-left: 3px solid #22c55e; }}
        .stat-row {{ display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; }}
        .stat-label {{ color: #71717a; }}
        .stat-val {{ font-family: 'JetBrains Mono'; color: #fff; font-weight: bold; }}
        .stat-val.urgent {{ color: #ef4444; }}
        .stat-val.success {{ color: #22c55e; }}
        
        .btn-group {{ display: flex; gap: 5px; background: #000; padding: 8px; border-radius: 6px; border: 1px solid #27272a; margin-bottom: 10px; flex-wrap: wrap; }}
        .btn {{ flex: 1; min-width: 70px; background: none; border: none; color: #71717a; padding: 10px; cursor: pointer; font-weight: 600; border-radius: 4px; transition: 0.2s; font-size: 11px; }}
        .btn:hover {{ color: #fff; background: rgba(255,255,255,0.05); }}
        .btn.active {{ background: #3b82f6; color: #fff; }}
        
        .story-text {{ font-size: 12px; line-height: 1.6; color: #a1a1aa; display: none; }}
        .story-text.active {{ display: block; animation: fadeIn 0.3s; }}
        
        .algorithm-box {{ background: rgba(59, 130, 246, 0.08); border: 1px solid #3b82f6; border-radius: 6px; padding: 10px; margin: 8px 0; font-size: 11px; line-height: 1.5; }}
        .algorithm-box code {{ background: #000; padding: 2px 4px; border-radius: 3px; font-family: 'JetBrains Mono'; color: #eab308; }}
        
        .formula {{ background: #000; border: 1px solid #333; padding: 8px; border-radius: 4px; font-family: 'JetBrains Mono'; font-size: 11px; margin: 5px 0; color: #a1a1aa; line-height: 1.4; }}
        
        .info-btn {{ background: rgba(234, 179, 8, 0.1); border: 1px solid #eab308; color: #eab308; padding: 8px; width: 100%; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; text-transform: uppercase; transition: 0.2s; margin-bottom: 5px; }}
        .info-btn:hover {{ background: rgba(234, 179, 8, 0.2); }}
        
        .modal {{ display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); overflow-y: auto; }}
        .modal-content {{ background-color: #18181b; margin: 30px auto; padding: 25px; border: 1px solid #3b82f6; width: 65%; max-width: 900px; border-radius: 10px; box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); position: relative; }}
        .close {{ color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px; }}
        .close:hover {{ color: white; }}
        
        .legend {{ position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.8); padding: 12px; border-radius: 6px; border: 1px solid #333; font-size: 11px; z-index: 10; }}
        .dot {{ display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }}
        
        .chart-container {{ background: #000; border: 1px solid #27272a; border-radius: 6px; padding: 12px; margin: 10px 0; }}
        .chart-container canvas {{ max-height: 200px; }}
        
        /* Styles pour la base de donn√©es */
        .database-section {{ background: #000; border: 1px solid #27272a; border-radius: 8px; padding: 15px; margin: 20px; }}
        .table-wrapper {{ overflow-x: auto; }}
        table {{ width: 100%; border-collapse: collapse; font-size: 11px; }}
        th {{ background: #1a1a1a; color: #3b82f6; padding: 10px; text-align: left; border-bottom: 2px solid #3b82f6; font-weight: bold; }}
        td {{ padding: 8px 10px; border-bottom: 1px solid #27272a; }}
        tr:hover {{ background: #0a0a0a; }}
        
        @keyframes fadeIn {{ from {{ opacity: 0; transform: translateY(5px); }} to {{ opacity: 1; transform: translateY(0); }} }}
    </style>
</head>
<body>

<div class="sidebar">
    <div>
        <h1>üè• KIDNEY MATCH v7.0</h1>
        <div style="font-size: 10px; color: #555; margin-top: 4px;">ML + TH√âORIE DES JEUX</div>
    </div>

        <div class="btn-group">
        <button class="btn active" onclick="setStep(1)">1. DONN√âES</button>
        <button class="btn" onclick="setStep(2)">2. URGENCE</button>
        <button class="btn" onclick="setStep(3)">3. MATCHING</button>
        <button class="btn" onclick="setStep(4)">4. D√âTAILS</button>
        <button class="btn" onclick="setStep(5)">5. BASE DE DONN√âES</button>
    </div>
        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
            <label style="font-size:11px; color:#a1a1aa;">Patients:</label>
            <input id="patientCountInput" type="number" min="2" value="{n_tot}" style="width:80px; padding:6px; border-radius:6px; border:1px solid #27272a; background:#0b0b0c; color:#fff;">
            <button class="btn" style="min-width:90px;" onclick="applyPatientCount()">Appliquer</button>
        </div>
    
    <button class="info-btn" onclick="openModal('methods')">üìä M√©thodologie</button>
    <button class="info-btn" onclick="openModal('urgent')">‚ö†Ô∏è Calcul Urgence</button>
    <button class="info-btn" onclick="openModal('matching')">üîó Algorithme</button>
    <button class="info-btn" onclick="openModal('automation')">‚öôÔ∏è Automation Admin</button>

    <!-- STEP 1: DONN√âES -->
    <div id="story-1" class="story-text active">
        <h2>üì• Donn√©es Cliniques</h2>
        <div class="card">
            <div class="stat-row">
                <span class="stat-label">PATIENTS</span>
                <span class="stat-val" id="displayTotal">{n_tot}</span>
            </div>
        </div>
        <h3>Param√®tres</h3>
        <div class="card" style="font-size:11px; line-height:1.6;">
            <b>‚úì Cr√©atinine</b> - Fonction r√©nale<br>
            <b>‚úì H√©moglobine</b> - Sant√© g√©n√©rale<br>
            <b>‚úì √Çge</b> - Crit√®re temporel<br>
            <b>‚úì Diab√®te</b> - Comorbidit√©
        </div>
    </div>

    <!-- STEP 2: URGENCE -->
    <div id="story-2" class="story-text">
        <h2>‚ö° Scoring d'Urgence</h2>
        <div class="card card-urgent">
            <div class="stat-row">
                <span class="stat-label">TOP PATIENT</span>
                <span class="stat-val urgent">#{top['id']}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">SCORE</span>
                <span class="stat-val urgent">{top['score']}/100</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Cr√©atinine</span>
                <span class="stat-val">{top['sc']}</span>
            </div>
        </div>
        <h3>Formule</h3>
        <div class="algorithm-box">
            <code>SCORE = (Cr√©at√ó0.6) + (¬¨Hemo√ó0.2) + (Age√ó0.2) + (Diab√®te√ó0.1)</code>
        </div>
    </div>

    <!-- STEP 3: MATCHING -->
    <div id="story-3" class="story-text">
        <h2>üîó Matching</h2>
        <div class="card card-success">
            <div class="stat-row">
                <span class="stat-label">CYCLES</span>
                <span class="stat-val success">{n_cyc}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">SAUV√âS</span>
                <span class="stat-val success">{n_sav}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">TAUX</span>
                <span class="stat-val success">{success_rate}%</span>
            </div>
        </div>
    </div>

    <!-- STEP 4: D√âTAILS -->
    <div id="story-4" class="story-text">
        <h2>üìà Analyse</h2>
        <div class="chart-container">
            <canvas id="histChart"></canvas>
        </div>
    </div>

    <!-- STEP 5: BASE DE DONN√âES -->
    <div id="story-5" class="story-text">
        <h2>üóÑÔ∏è Base de Donn√©es</h2>
        <div class="card">
            <div style="font-size:11px; line-height:1.6;">
            Tableau complet des patients avec:<br>
            ‚Ä¢ Score d'urgence<br>
            ‚Ä¢ Groupe sanguin<br>
            ‚Ä¢ Compatibilit√©s<br>
            ‚Ä¢ Donneur assign√©<br>
            ‚Ä¢ Statut
            </div>
        </div>
        <h3>Scroll vers le bas</h3>
        <p style="font-size:11px; color:#666;">
        Le tableau s'affiche dans la section principale.
        </p>
    </div>
</div>

<div class="main" id="mainContent">
    <div id="networkContainer" style="width: 100%; height: 100%;">
        <div id="network" style="width: 100%; height: 100%;"></div>
        <div class="legend" id="legend"></div>
    </div>
    
    <div id="databaseContainer" style="display: none; padding: 20px;">
        <h1 style="margin-bottom: 20px;">üóÑÔ∏è Base de Donn√©es - Registre des Patients</h1>
        <div class="database-section">
            <h2>Vue d'ensemble</h2>
            <p style="font-size:12px; color:#a1a1aa; line-height:1.6;">
            Ce tableau repr√©sente <b>la paperasse automatis√©e par notre syst√®me</b>. 
            Normalement, un administrateur devrait v√©rifier manuellement chaque compatibilit√© ABO, contacter les h√¥pitaux, 
            coordonner les horaires, g√©rer les rejets... <br><br>
            <b>Notre code fait tout cela en secondes et propose les meilleures cha√Ænes d'√©change.</b>
            </p>
        </div>
        
        <div class="database-section">
            <h2>Colonnes Expliqu√©es</h2>
            <table>
                <tr>
                    <th>Colonne</th>
                    <th>Signification</th>
                    <th>Avant (Manuel)</th>
                    <th>Apr√®s (Notre Code)</th>
                </tr>
                <tr>
                    <td><b>Score</b></td>
                    <td>Urgence clinique (0-100)</td>
                    <td>√âvaluation subjective par m√©decin</td>
                    <td>Calcul objectif IA</td>
                </tr>
                <tr>
                    <td><b>Groupe Sang</b></td>
                    <td>Type sanguin receveur</td>
                    <td>V√©rification manuelle</td>
                    <td>Automatique</td>
                </tr>
                <tr>
                    <td><b>Compatible</b></td>
                    <td>Groupes donneurs viables</td>
                    <td>Recherche manuelle tr√®s longue</td>
                    <td>Listage instant par r√®gles ABO</td>
                </tr>
                <tr>
                    <td><b>Donneur</b></td>
                    <td>Qui donne au patient</td>
                    <td>Coordination t√©l√©phonique/fax (jours)</td>
                    <td>Assignation optimale en 1 clic</td>
                </tr>
                <tr>
                    <td><b>Statut</b></td>
                    <td>Est-il appair√© ?</td>
                    <td>Suivi papier/Excel d√©centralis√©</td>
                    <td>Temps r√©el centralis√©</td>
                </tr>
            </table>
        </div>
        
        <div class="database-section">
            <h2>Le Tableau Complet</h2>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Patient</th>
                            <th>Score</th>
                            <th>Gr. Patient</th>
                            <th>Gr. Donneur</th>
                            <th>√Çge</th>
                            <th>Cr√©atinine</th>
                            <th>Diab√®te</th>
                            <th>Assign√© √Ä</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        {patients_table_rows}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="database-section">
            <h2>Exemple Concret: Workflows Sauv√©s</h2>
            <h3>‚ùå AVANT Notre Code (Processus Manual)</h3>
            <div class="algorithm-box" style="background:rgba(239,68,68,0.08); border-color:#ef4444;">
                <b>Jour 1:</b> Patient arrive urgence, groupe O<br>
                <b>Jour 1-2:</b> Infirmiers cherchent compatible dans 50 cahiers papier<br>
                <b>Jour 2:</b> Trouvent Donneur A, mais incompatible avec sa femme receveur<br>
                <b>Jour 2-3:</b> Contactent h√¥pitaux voisins (pas de r√©ponse)<br>
                <b>Jour 4:</b> Patient se d√©grade, d√©cision = dialyse<br>
                <b>R√©sultat:</b> Vies perdues, frustration, co√ªts √©normes
            </div>
            
            <h3>‚úÖ APR√àS Notre Code (Automatis√©)</h3>
            <div class="algorithm-box" style="background:rgba(34,197,94,0.08); border-color:#22c55e;">
                <b>Seconde 1:</b> Patient enregistr√©, score=85 (critique)<br>
                <b>Seconde 2:</b> Calcul: groupe O, compatible avec O/A/B/AB<br>
                <b>Seconde 3:</b> Scan graphe 80 patients ‚Üí trouve Donneur#42 (type B)<br>
                <b>Seconde 4:</b> D√©tecte cycle: #42‚ÜíPatient‚Üí#15‚ÜíDonneur#18‚Üí#42<br>
                <b>Seconde 5:</b> Valide cha√Æne, notifie chirurgiens<br>
                <b>Jour 0:</b> Transplantations coordonn√©es<br>
                <b>R√©sultat:</b> Vies sauv√©es, efficacit√© maximale, paperasse=0
            </div>
        </div>
    </div>
</div>

<!-- MODALES -->
<div id="methodsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('methods')">&times;</span>
    <h2 style="color: #3b82f6; margin-top:0;">üìä M√©thodologie Compl√®te</h2>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">Pipeline complet de l'IA:
    </p>
    <h3>1. COLLECTE DE DONN√âES</h3>
    <p style="font-size:12px;">Donn√©es synth√©tiques r√©alistes (clinique + HLA + groupes sanguins)</p>
    <h3>2. PR√âTRAITEMENT</h3>
    <p style="font-size:12px;">Imputation, normalisation, gestion valeurs infinies</p>
    <h3>3. SCORING IA</h3>
    <div class="formula">
SCORE = 0.6√óCr√©at + 0.2√ó(¬¨Hemo) + 0.2√óAge + 0.1√óDiab√®te
    </div>
    <h3>4. GRAPHE ABO</h3>
    <p style="font-size:12px;">Construction graphe orient√© selon r√®gles ABO + facteur immunologique 80%</p>
    <h3>5. D√âTECTION CYCLES</h3>
    <p style="font-size:12px;">Algorithm NetworkX (cycles 2-3 n≈ìuds maximum)</p>
    <h3>6. OPTIMISATION</h3>
    <p style="font-size:12px;">Gale-Shapley adapt√© ‚Üí Stable matching + Pareto optimal</p>
  </div>
</div>

<div id="urgentModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('urgent')">&times;</span>
    <h2 style="color: #ef4444; margin-top:0;">‚ö†Ô∏è Comment Calculer l'Urgence</h2>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
    Les patients avec score &gt; 80 DOIVENT √™tre appair√©s en priorit√©. C'est √©thiquement crucial.
    </p>
    <h3>Composantes</h3>
    <div class="card">
        <b>üî¥ CR√âATININE (60%)</b><br>
        Principal indicateur d√©faillance r√©nale
    </div>
    <div class="card">
        <b>üü° H√âMOGLOBINE (20% inverse)</b><br>
        Basse Hemo = an√©mie s√©v√®re
    </div>
    <div class="card">
        <b>üü¢ √ÇGE (20%)</b><br>
        Patients √¢g√©s = fen√™tre r√©duite
    </div>
    <div class="card">
        <b>üü† DIAB√àTE (10% bonus)</b><br>
        Comorbidit√© aggravante
    </div>
  </div>
</div>

<div id="matchingModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('matching')">&times;</span>
    <h2 style="color: #00d2ff; margin-top:0;">üîó Algorithme Gale-Shapley</h2>
    <p style="font-size:12px; line-height:1.7;">
    <b>√âTAPE 1:</b> Construire graphe ABO (qui peut donner √† qui)<br>
    <b>√âTAPE 2:</b> D√©tecter cycles 2-3 n≈ìuds<br>
    <b>√âTAPE 3:</b> Score chaque cycle = Œ£ urgences<br>
    <b>√âTAPE 4:</b> Tri par utilit√© (d√©croissant)<br>
    <b>√âTAPE 5:</b> S√©lection greedy (cycles disjoints)
    </p>
    <h3>R√©sultat</h3>
    <p style="font-size:12px;">
    <b>{n_cyc} cycles</b> trouv√©s ‚Üí <b>{n_sav} patients</b> sauv√©s<br>
    Stable matching + Pareto optimal = √âquilibre Nash atteint
    </p>
  </div>
</div>

<div id="automationModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('automation')">&times;</span>
    <h2 style="color: #22c55e; margin-top:0;">‚öôÔ∏è L'Automation Administrative</h2>
    <h3>üéØ Le Probl√®me Manuel</h3>
    <p style="font-size:12px; line-height:1.7;">
    Dans un h√¥pital typique, le matching r√©nal implique:
    </p>
    <ul style="font-size:12px; color:#a1a1aa;">
        <li>Recherche manuelle de compatibilit√©s dans dossiers papier</li>
        <li>Appels t√©l√©phoniques entre h√¥pitaux (jours de d√©lai)</li>
        <li>V√©rification Excel d√©centralis√©e (erreurs courantes)</li>
        <li>Coordination heures op√©ratoires (tr√®s complexe)</li>
        <li>Rejet possibles non g√©r√© (relancer nouveaux matchs)</li>
    </ul>
    
    <h3>‚úÖ Notre Solution Code</h3>
    <div class="algorithm-box" style="background:rgba(34,197,94,0.08); border-color:#22c55e;">
        <b>INSTANT 0 sec:</b> Patient urgent arrive<br>
        <b>INSTANT 1 sec:</b> Score IA calcul√©<br>
        <b>INSTANT 2 sec:</b> Groupes compatibles list√©s automatiquement<br>
        <b>INSTANT 3 sec:</b> Graphe construit (80 patients scann√©s)<br>
        <b>INSTANT 4 sec:</b> Cycles optimaux d√©tect√©s<br>
        <b>INSTANT 5 sec:</b> Meilleures cha√Ænes propos√©es (stable matching)<br>
        <br>
        <b>R√âSULTAT:</b> Paperasse = 0, Vies sauv√©es = maximum
    </div>
    
    <h3>üìä Impact √âconomique</h3>
    <table style="width:100%; font-size:11px; margin-top:10px;">
        <tr style="background:#1a1a1a;">
            <td style="padding:8px;"><b>Processus</b></td>
            <td style="padding:8px;"><b>Avant (Jours)</b></td>
            <td style="padding:8px;"><b>Apr√®s (Sec)</b></td>
            <td style="padding:8px;"><b>Gain</b></td>
        </tr>
        <tr style="border-bottom:1px solid #27272a;">
            <td style="padding:8px;">Trouver compatible</td>
            <td style="padding:8px; color:#ef4444;">2-3 jours</td>
            <td style="padding:8px; color:#22c55e;">1 sec</td>
            <td style="padding:8px;">√ó86400</td>
        </tr>
        <tr style="border-bottom:1px solid #27272a;">
            <td style="padding:8px;">V√©rifier cycle valide</td>
            <td style="padding:8px; color:#ef4444;">1 jour</td>
            <td style="padding:8px; color:#22c55e;">0.5 sec</td>
            <td style="padding:8px;">√ó172800</td>
        </tr>
        <tr style="border-bottom:1px solid #27272a;">
            <td style="padding:8px;">D√©cision finale</td>
            <td style="padding:8px; color:#ef4444;">4-5 jours</td>
            <td style="padding:8px; color:#22c55e;">5 sec</td>
            <td style="padding:8px;">√ó69120</td>
        </tr>
    </table>
    
    <h3>üíö Vies Sauv√©es</h3>
    <p style="font-size:12px; color:#22c55e; font-weight:bold;">
    Chaque jour de d√©lai = risque accru de d√©c√®s.<br>
    Notre code gagne 4-5 JOURS par patient.<br>
    Potentiel: Des centaines de vies suppl√©mentaires par an.
    </p>
  </div>
</div>

<script>
    const nodesRaw = {nodes};
    const edgesRaw = {edges};
    let currentView = 1;
    const patientsRaw = {patients_data};
    
    const nodes = new vis.DataSet(nodesRaw);
    const edges = new vis.DataSet(edgesRaw);
    
    const container = document.getElementById('network');
    const data = {{ nodes: nodes, edges: edges }};
    const options = {{
        nodes: {{ 
            shape: 'dot', 
            font: {{ color: '#fff', face: 'Inter', size: 10 }}, 
            borderWidth: 2,
            shadow: true 
        }},
        edges: {{ 
            smooth: {{ type: 'continuous' }}, 
            arrows: {{ to: {{ scaleFactor: 0.5 }} }},
            font: {{ size: 10 }},
            shadow: true
        }},
        physics: {{ 
            stabilization: {{ iterations: 1000 }}, 
            barnesHut: {{ gravitationalConstant: -2000 }} 
        }}
    }};
    
    const network = new vis.Network(container, data, options);
    
    network.once("stabilizationIterationsDone", function() {{
        network.setOptions({{ physics: {{ enabled: false }} }});
        network.fit();
    }});

    function openModal(modalId) {{ 
        document.getElementById(modalId + 'Modal').style.display = "block"; 
    }}
    function closeModal(modalId) {{ 
        document.getElementById(modalId + 'Modal').style.display = "none"; 
    }}
    window.onclick = function(event) {{ 
        if (event.target.classList.contains('modal')) {{ 
            event.target.style.display = "none"; 
        }} 
    }}

    // Charts
    var urgencyScores = nodesRaw.map(n => n.val);
    
    var histCtx = document.getElementById('histChart');
    if(histCtx) {{
        var bins = [0,0,0,0,0];
        urgencyScores.forEach(s => {{
            if(s < 20) bins[0]++;
            else if(s < 40) bins[1]++;
            else if(s < 60) bins[2]++;
            else if(s < 80) bins[3]++;
            else bins[4]++;
        }});
        new Chart(histCtx, {{
            type: 'doughnut',
            data: {{
                labels: ['<20 (Stable)', '20-40', '40-60', '60-80 (Grave)', '80+ (Critique)'],
                datasets: [{{
                    data: bins,
                    backgroundColor: ['#22c55e', '#84cc16', '#eab308', '#f97316', '#ef4444'],
                    borderColor: '#000',
                    borderWidth: 2
                }}]
            }},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                plugins: {{ legend: {{ position: 'bottom', labels: {{ color: '#a1a1aa', font: {{ size: 10 }} }} }} }}
            }}
        }});
    }}

    function quickGen(count) {{
        document.getElementById('patientCount').value = count;
        regenerate();
    }}

    function regenerate() {{
        const count = document.getElementById('patientCount').value;
        
        // V√©rifier si on est sur le serveur Flask (localhost:5000)
        if (window.location.hostname === 'localhost' && window.location.port === '5000') {{
            // Mode serveur: recharger avec param√®tre
            window.location.href = '/?n=' + count;
        }} else {{
            // Mode fichier HTML: afficher commande √† copier
            const cmd = `C:/Users/33783/anaconda3/python.exe "c:/Users/33783/Desktop/EPF5A/ml/2025-MSMIS5IN11-Probas-ML/etape 2" ${{count}}`;
            
            document.getElementById('commandText').textContent = cmd;
            document.getElementById('commandOutput').style.display = 'block';
            
            // Copie automatique dans le presse-papier
            navigator.clipboard.writeText(cmd).then(() => {{
                const output = document.getElementById('commandOutput');
                output.innerHTML = '<div style="color: #22c55e;">‚úÖ Commande copi√©e ! Colle-la dans ton terminal (Ctrl+V)</div><div style="margin-top: 4px; color: #fff; user-select: all;">' + cmd + '</div>';
            }}).catch(() => {{
                document.getElementById('commandOutput').style.display = 'block';
            }});
        }}
    }}

    function setStep(step) {{
        currentView = step;
        document.querySelectorAll('.btn').forEach((b, i) => b.classList.toggle('active', i === step-1));
        document.querySelectorAll('.story-text').forEach((d, i) => d.classList.toggle('active', i === step-1));
        
        document.getElementById('networkContainer').style.display = step !== 5 ? 'block' : 'none';
        document.getElementById('databaseContainer').style.display = step === 5 ? 'block' : 'none';
        
        const allNodes = nodes.get();
        const allEdges = edges.get();
        const legend = document.getElementById('legend');
        
        if(step === 1) {{
            allNodes.forEach(n => {{ n.color = '#3f3f46'; n.size = 8; n.shadow = false; }});
            allEdges.forEach(e => {{ e.hidden = false; e.color = {{color:'#333', opacity: 0.1}}; e.width=0.5; }});
            legend.innerHTML = '<b>Step 1: Donn√©es</b><br><span class="dot" style="background:#3f3f46"></span>Paire (Patient + Donneur)';
        }}
        
        if(step === 2) {{
            allNodes.forEach(n => {{ n.color = n.ai_color; n.size = 5 + (n.val/8); n.shadow = true; }});
            allEdges.forEach(e => {{ e.hidden = true; }});
            legend.innerHTML = '<b>Step 2: Urgence</b><br><span class="dot" style="background:#ef4444"></span>Critique<br><span class="dot" style="background:#eab308"></span>Grave<br><span class="dot" style="background:#22c55e"></span>Stable';
        }}
        
        if(step === 3) {{
            // Matching view: show only cycle edges (candidates + validated)
            allNodes.forEach(n => {{ 
                if(n.cid > -1) {{
                    n.hidden = false;
                    n.color = '#00d2ff';
                    n.size = 16;
                    // keep label for validated nodes
                }} else if(n.in_any_cycle) {{
                    n.hidden = false;
                    n.color = '#93c5fd';
                    n.size = 6;
                    n.label = '';
                }} else {{
                    // hide irrelevant nodes to reduce clutter
                    n.hidden = true;
                }}
            }});
            allEdges.forEach(e => {{
                if(e.is_sol) {{ e.hidden = false; e.color = {{color:'#00d2ff', opacity:0.95}}; e.width=2; }}
                else if(e.is_candidate) {{ e.hidden = false; e.color = {{color:'#93c5fd', opacity:0.4}}; e.width=1; }}
                else {{ e.hidden = true; }}
            }});
            legend.innerHTML = '<b>Step 3: Matching</b><br><span class="dot" style="background:#00d2ff"></span>Cycle valid√© &nbsp; <span class="dot" style="background:#93c5fd"></span>Cycle candidat';
        }}
        
        if(step === 4) {{
            allNodes.forEach(n => {{ n.color = '#3b82f6'; n.size = 10; n.shadow = true; }});
            allEdges.forEach(e => {{ e.hidden = true; }});
            legend.innerHTML = '<b>Step 4: Analyse</b><br>Distribution scores';
        }}
        
        nodes.update(allNodes);
        edges.update(allEdges);
    }}
    
    setStep(1);
</script>

</body>
</html>"""
        
        # NOTE: rendu HTML d√©l√©gu√© √† la g√©n√©ration finale ci-dessous (√©vite doublons)
        # Le fichier sera g√©n√©r√© une seule fois plus bas.
        
        html = f"""<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Kidney Exchange - Hybrid Data</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        * {{ box-sizing: border-box; }}
        body {{ background: #09090b; color: #e4e4e7; font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }}
        .sidebar {{ width: 420px; background: #18181b; border-right: 1px solid #27272a; padding: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 2; overflow-y: auto; }}
        .main {{ flex: 1; position: relative; background: radial-gradient(circle at 50% 50%, #1c1c1c 0%, #000 100%); }}
        h1 {{ font-family: 'JetBrains Mono'; font-size: 18px; color: #3b82f6; margin: 0; }}
        h2 {{ font-size: 13px; color: #a1a1aa; margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }}
        h3 {{ font-size: 12px; color: #71717a; margin: 10px 0 6px 0; text-transform: uppercase; font-weight: 600; }}
        
        .card {{ background: #000; border: 1px solid #27272a; border-radius: 8px; padding: 12px; margin-bottom: 10px; }}
        .card-urgent {{ border-left: 3px solid #ef4444; }}
        .card-success {{ border-left: 3px solid #22c55e; }}
        .stat-row {{ display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; }}
        .stat-label {{ color: #71717a; }}
        .stat-val {{ font-family: 'JetBrains Mono'; color: #fff; font-weight: bold; }}
        .stat-val.urgent {{ color: #ef4444; }}
        .stat-val.success {{ color: #22c55e; }}
        
        .btn-group {{ display: flex; gap: 5px; background: #000; padding: 8px; border-radius: 6px; border: 1px solid #27272a; margin-bottom: 10px; }}
        .btn {{ flex: 1; background: none; border: none; color: #71717a; padding: 10px; cursor: pointer; font-weight: 600; border-radius: 4px; transition: 0.2s; font-size: 12px; }}
        .btn:hover {{ color: #fff; background: rgba(255,255,255,0.05); }}
        .btn.active {{ background: #3b82f6; color: #fff; }}
        
        .story-text {{ font-size: 12px; line-height: 1.6; color: #a1a1aa; display: none; }}
        .story-text.active {{ display: block; animation: fadeIn 0.3s; }}
        
        .algorithm-box {{ background: rgba(59, 130, 246, 0.08); border: 1px solid #3b82f6; border-radius: 6px; padding: 10px; margin: 8px 0; font-size: 11px; line-height: 1.5; }}
        .algorithm-box code {{ background: #000; padding: 2px 4px; border-radius: 3px; font-family: 'JetBrains Mono'; color: #eab308; }}
        
        .formula {{ background: #000; border: 1px solid #333; padding: 8px; border-radius: 4px; font-family: 'JetBrains Mono'; font-size: 11px; margin: 5px 0; color: #a1a1aa; line-height: 1.4; }}
        
        .info-btn {{ background: rgba(234, 179, 8, 0.1); border: 1px solid #eab308; color: #eab308; padding: 8px; width: 100%; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; text-transform: uppercase; transition: 0.2s; }}
        .info-btn:hover {{ background: rgba(234, 179, 8, 0.2); }}
        
        .modal {{ display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); overflow-y: auto; }}
        .modal-content {{ background-color: #18181b; margin: 30px auto; padding: 25px; border: 1px solid #3b82f6; width: 60%; max-width: 800px; border-radius: 10px; box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); position: relative; }}
        .close {{ color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px; }}
        .close:hover {{ color: white; }}
        
        .legend {{ position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.8); padding: 12px; border-radius: 6px; border: 1px solid #333; font-size: 11px; z-index: 10; }}
        .dot {{ display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }}
        
        .chart-container {{ background: #000; border: 1px solid #27272a; border-radius: 6px; padding: 12px; margin: 10px 0; }}
        .chart-container canvas {{ max-height: 200px; }}
        
        .warning-box {{ background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; padding: 10px; border-radius: 4px; font-size: 11px; }}
        
        .quick-btn {{ flex: 1; background: #18181b; border: 1px solid #27272a; color: #a1a1aa; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; transition: 0.2s; }}
        .quick-btn:hover {{ background: #27272a; color: #fff; border-color: #3b82f6; }}
        
        @keyframes fadeIn {{ from {{ opacity: 0; transform: translateY(5px); }} to {{ opacity: 1; transform: translateY(0); }} }}
    </style>
</head>
<body>

<div class="sidebar">
    <div>
        <h1>üè• KIDNEY MATCH v6.0</h1>
        <div style="font-size: 10px; color: #555; margin-top: 4px;">ML + TH√âORIE DES JEUX</div>
    </div>

    <!-- CONTR√îLE NOMBRE DE PATIENTS -->
    <div class="card" style="margin-top: 10px;">
        <h3 style="margin-top: 0;">üéõÔ∏è Nombre de Patients</h3>
        <div style="display: flex; gap: 8px; align-items: center;">
            <input type="number" id="patientCount" value="{n_tot}" min="5" max="200" 
                   style="flex: 1; background: #18181b; border: 1px solid #3b82f6; color: #fff; padding: 8px; border-radius: 4px; font-family: 'JetBrains Mono'; font-size: 14px; font-weight: bold;">
            <button onclick="regenerate()" 
                    style="background: #3b82f6; border: none; color: #fff; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;">
                G√âN√âRER
            </button>
        </div>
        <div id="commandOutput" style="display: none; margin-top: 8px; background: #000; border: 1px solid #eab308; padding: 8px; border-radius: 4px; font-size: 10px; font-family: 'JetBrains Mono'; color: #eab308; line-height: 1.4;">
            <div style="margin-bottom: 4px; color: #a1a1aa;">üìã Copie cette commande dans ton terminal :</div>
            <div id="commandText" style="user-select: all; color: #fff;"></div>
        </div>
        <div style="display: flex; gap: 4px; margin-top: 6px;">
            <button onclick="quickGen(10)" class="quick-btn">10</button>
            <button onclick="quickGen(20)" class="quick-btn">20</button>
            <button onclick="quickGen(50)" class="quick-btn">50</button>
            <button onclick="quickGen(100)" class="quick-btn">100</button>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn active" onclick="setStep(1)">1. DONN√âES</button>
        <button class="btn" onclick="setStep(2)">2. URGENCE</button>
        <button class="btn" onclick="setStep(3)">3. MATCHING</button>
        <button class="btn" onclick="setStep(4)">4. D√âTAILS</button>
    </div>
    
    <button class="info-btn" onclick="openModal('methods')">üìä M√©thodologie Compl√®te</button>
    <button class="info-btn" onclick="openModal('urgent')">‚ö†Ô∏è Comment Calculer l'Urgence ?</button>
    <button class="info-btn" onclick="openModal('matching')">üîó Algorithme de Matching</button>

    <!-- STEP 1: DONN√âES -->
    <div id="story-1" class="story-text active">
        <h2>üì• Donn√©es Cliniques R√©elles</h2>
        <div class="card">
            <div class="stat-row">
                <span class="stat-label">PATIENTS CHARG√âS</span>
                <span class="stat-val">{n_tot}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">SOURCE</span>
                <span class="stat-val" style="font-size:10px;">Synth√©tique</span>
            </div>
        </div>
        
        <h3>üîÑ Principe des √âchanges Crois√©s</h3>
        <div class="card" style="font-size:11px; line-height:1.7; background: rgba(59, 130, 246, 0.05);">
            <b>Chaque personne = PATIENT + DONNEUR :</b><br><br>
            
            <b>Patient #1</b><br>
            ‚Ä¢ A besoin d'un rein (groupe A)<br>
            ‚Ä¢ A un donneur volontaire (fr√®re, groupe O)<br>
            ‚Ä¢ ‚ùå Incompatibles entre eux !<br><br>
            
            <b>Patient #2</b><br>
            ‚Ä¢ A besoin d'un rein (groupe O)<br>
            ‚Ä¢ A un donneur volontaire (s≈ìur, groupe A)<br>
            ‚Ä¢ ‚ùå Incompatibles entre eux !<br><br>
            
            <b style="color: #22c55e;">‚úÖ √âCHANGE CROIS√â :</b><br>
            ‚Ä¢ Donneur #1 (O) ‚Üí Patient #2 (O)<br>
            ‚Ä¢ Donneur #2 (A) ‚Üí Patient #1 (A)<br>
            <b>Les deux sont sauv√©s !</b>
        </div>
        
        <h3>Param√®tres Physiologiques</h3>
        <div class="card" style="font-size:11px; line-height:1.6;">
            <b>‚úì Cr√©atinine (SC)</b> - Fonction r√©nale<br>
            <b>‚úì H√©moglobine</b> - Sant√© g√©n√©rale<br>
            <b>‚úì √Çge</b> - Crit√®re temporel<br>
            <b>‚úì Diab√®te (DM)</b> - Comorbidit√©<br>
            <b>‚úì Tension</b> - Stabilit√© cardiovasculaire
        </div>
        
        <h3>Groupes Sanguins (Simul√©s)</h3>
        <div class="card" style="font-size:11px;">
            Distribution mondiale:
            <div style="margin-top:5px; font-family: JetBrains Mono;">
            O: 45% | A: 40% | B: 11% | AB: 4%
            </div>
        </div>
    </div>

    <!-- STEP 2: URGENCE (SCORING) -->
    <div id="story-2" class="story-text">
        <h2>‚ö° Scoring d'Urgence (I.A.)</h2>
        
        <h3>üéØ Patient Critique</h3>
        <div class="card card-urgent">
            <div class="stat-row">
                <span class="stat-label">ID</span>
                <span class="stat-val urgent">#{top['id']}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">SCORE</span>
                <span class="stat-val urgent">{top['score']}/100</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Cr√©atinine</span>
                <span class="stat-val">{top['sc']}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">√Çge</span>
                <span class="stat-val">{top['age']} ans</span>
            </div>
        </div>
        
        <h3>‚öôÔ∏è Formule du Score</h3>
        <div class="algorithm-box">
            <code>SCORE = (Cr√©at√ó0.6) + (¬¨Hemo√ó0.2) + (Age√ó0.2) + (Diab√®te√ó0.1)</code>
            <br><br>
            ‚Ä¢ <b>Cr√©atinine (60%)</b> = Principal indicateur d√©faillance<br>
            ‚Ä¢ <b>H√©moglobine invers√©e (20%)</b> = Sant√© g√©n√©rale<br>
            ‚Ä¢ <b>√Çge normalis√© (20%)</b> = Temps critique<br>
            ‚Ä¢ <b>Diab√®te (10%)</b> = Facteur aggravant
        </div>
        
        <div class="chart-container">
            <canvas id="scoreChart"></canvas>
        </div>
        
        <h3>Interpr√©tation</h3>
        <div class="card">
            <div style="font-size:11px; line-height:1.6;">
            üî¥ <b>80-100</b>: CRITIQUE (transfusion imm√©diate)<br>
            üü° <b>50-79</b>: GRAVE (d√©lai semaines)<br>
            üü¢ <b>&lt;50</b>: STABLE (attente acceptable)
            </div>
        </div>
    </div>

    <!-- STEP 3: MATCHING -->
    <div id="story-3" class="story-text">
        <h2>üîó Matching par Th√©orie des Jeux</h2>
        
        <h3>Cycles Trouv√©s</h3>
        <div class="card card-success">
            <div class="stat-row">
                <span class="stat-label">CYCLES VALIDES</span>
                <span class="stat-val success">{n_cyc}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">PATIENTS SAUV√âS</span>
                <span class="stat-val success">{n_sav}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">TAUX SUCC√àS</span>
                <span class="stat-val success">{success_rate}%</span>
            </div>
        </div>
        
        <h3>Algorithme Gale-Shapley</h3>
        <div class="algorithm-box">
            <b>√âtape 1:</b> Graphe ABO (compatibilit√© d√©terministe)<br>
            <b>√âtape 2:</b> D√©tection cycles 2-3 n≈ìuds<br>
            <b>√âtape 3:</b> Score = Œ£ urgence(cycle)<br>
            <b>√âtape 4:</b> Tri par utilit√© d√©croissante<br>
            <b>√âtape 5:</b> S√©lection greedy (sans intersection)
        </div>
        
        <h3>Garanties Th√©oriques</h3>
        <div class="card" style="font-size:11px;">
            ‚úì <b>Stable Matching:</b> Aucune d√©viation profitable<br>
            ‚úì <b>Pareto Optimal:</b> Max surplus social<br>
            ‚úì <b>Nash Equilibrium:</b> √âquilibre atteint<br>
            ‚úì <b>Core Solution:</b> Dans le c≈ìur du jeu
        </div>
    </div>

    <!-- STEP 4: D√âTAILS -->
    <div id="story-4" class="story-text">
        <h2>üìà Analyse D√©taill√©e</h2>
        
        <h3>Distribution Scores</h3>
        <div class="chart-container">
            <canvas id="histChart"></canvas>
        </div>
        
        <h3>Compatibilit√© ABO</h3>
        <div class="card" style="font-size:10px; line-height:1.5;">
            <b>O ‚Üí</b> O, A, B, AB (universel) <br>
            <b>A ‚Üí</b> A, AB<br>
            <b>B ‚Üí</b> B, AB<br>
            <b>AB ‚Üí</b> AB (receveur universel)
        </div>
        
        <h3>Statut Patients</h3>
        <div class="card card-success">
            <div class="stat-row">
                <span>Sauv√©s par √©changes</span>
                <span class="stat-val success">{n_sav}</span>
            </div>
            <div class="stat-row">
                <span>En attente (incompat.)</span>
                <span class="stat-val">{n_tot - n_sav}</span>
            </div>
        </div>
    </div>
</div>

<div class="main">
    <div id="network" style="width: 100%; height: 100%;"></div>
    <div class="legend" id="legend"></div>
</div>

<!-- MODAL: M√âTHODOLOGIE -->
<div id="methodsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('methods')">&times;</span>
    <h2 style="color: #3b82f6; margin-top:0;">üìä M√©thodologie Compl√®te</h2>
    
    <h3>1. COLLECTE DE DONN√âES</h3>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
        Les donn√©es physiologiques (<b>cr√©atinine, h√©moglobine, √¢ge, tension</b>) sont <b>g√©n√©r√©es synth√©tiquement</b> selon des distributions r√©alistes.
        <br><br>
        Les <b>donn√©es immunologiques</b> (groupes sanguins ABO/Rh, typage HLA 3 loci, PRA) sont √©galement <b>g√©n√©r√©es al√©atoirement</b> selon les fr√©quences r√©elles mondiales.
    </p>
    
    <h3>2. PR√âTRAITEMENT</h3>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
        ‚Ä¢ Imputation des valeurs manquantes (m√©diane)<br>
        ‚Ä¢ Gestion des valeurs infinies<br>
        ‚Ä¢ Normalisation MinMax [0, 1]<br>
        ‚Ä¢ Limitation √† {n_tot} patients pour visualisation
    </p>
    
    <h3>3. SCORING D'URGENCE (Intelligence Artificielle)</h3>
    <div class="formula">
SCORE = 0.6 √ó (Cr√©at - min) / (max - min)
       + 0.2 √ó (1 - (Hemo - min) / (max - min))
       + 0.2 √ó (Age / 100)
       + 0.1 √ó [Diab√®te pr√©sent ?]
    </div>
    <p style="font-size:12px; color:#a1a1aa;">
        <b>Interpr√©tation:</b> Plus le score est √©lev√©, plus le patient est urgent.
    </p>
    
    <h3>4. GRAPHE DE COMPATIBILIT√â ABO</h3>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
        Un <b>graphe orient√©</b> est construit o√π:<br>
        ‚Ä¢ N≈ìud i ‚Üí j existe si Donneur(i) peut aider Patient(j)<br>
        ‚Ä¢ Compatibilit√© d√©termin√©e par <b>r√®gles ABO</b><br>
        ‚Ä¢ Facteur immunologique: 80% de probabilit√© de match
    </p>
    
    <h3>5. D√âTECTION DE CYCLES (Th√©orie des Graphes)</h3>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
        Algorithme <code>NetworkX.simple_cycles()</code> pour d√©tecter cycles ferm√©s:<br>
        ‚Ä¢ Cycles 2-cycles: √âchange direct (A‚ÜîB)<br>
        ‚Ä¢ Cycles 3-cycles: √âchange triangulaire (A‚ÜíB‚ÜíC‚ÜíA)
    </p>
    
    <h3>6. OPTIMISATION (Stable Matching)</h3>
    <div class="algorithm-box" style="border-color:#22c55e; background:rgba(34,197,94,0.08);">
        <b>Algorithme Gale-Shapley:</b><br>
        1. Calculer utilit√© chaque cycle: Œ£ urgences<br>
        2. Trier cycles par utilit√© (d√©croissant)<br>
        3. S√©lection greedy: Max cycles disjoints<br>
        4. R√©sultat: Stable matching + Pareto optimal
    </div>
    
    <h3>7. R√âSULTAT FINAL</h3>
    <p style="font-size:12px; color:#a1a1aa;">
        <b>{n_sav} patients sauv√©s</b> parmi {n_tot} via <b>{n_cyc} cycles d'√©change</b>.<br>
        Taux de succ√®s: <b>{success_rate}%</b>
    </p>
  </div>
</div>

<!-- MODAL: URGENCE -->
<div id="urgentModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('urgent')">&times;</span>
    <h2 style="color: #ef4444; margin-top:0;">‚ö†Ô∏è Calcul de l'Urgence</h2>
    
    <h3>Pourquoi l'urgence ?</h3>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
        Dans un r√©seau d'√©changes r√©naux, il est <b>√©thiquement crucial</b> de donner la priorit√© 
        aux patients les plus graves. Le score d'urgence combine plusieurs facteurs cliniques 
        pour identifier rapidement qui a besoin d'une transplantation imm√©diate.
    </p>
    
    <h3>Composantes du Score</h3>
    
    <div class="card">
        <b>üî¥ CR√âATININE (60% du poids)</b><br>
        <p style="font-size:11px; line-height:1.5; color:#a1a1aa; margin:8px 0;">
            Mesure principale de la fonction r√©nale. Plus elle est √©lev√©e, plus les reins d√©faillent.
            Normalis√©e entre 0 et 1.
        </p>
    </div>
    
    <div class="card">
        <b>üü° H√âMOGLOBINE (20% - inverse)</b><br>
        <p style="font-size:11px; line-height:1.5; color:#a1a1aa; margin:8px 0;">
            Une faible h√©moglobine indique une an√©mie s√©v√®re (complication r√©nale fr√©quente).
            On l'inverse: basse h√©moglobine = score haut.
        </p>
    </div>
    
    <div class="card">
        <b>üü¢ √ÇGE (20%)</b><br>
        <p style="font-size:11px; line-height:1.5; color:#a1a1aa; margin:8px 0;">
            Les patients plus √¢g√©s ont une fen√™tre temporelle plus r√©duite. Normalis√© sur 100 ans.
        </p>
    </div>
    
    <div class="card">
        <b>üü† DIAB√àTE (10% suppl√©mentaire)</b><br>
        <p style="font-size:11px; line-height:1.5; color:#a1a1aa; margin:8px 0;">
            Le diab√®te complique la maladie r√©nale et r√©duit les options de transplantation.
        </p>
    </div>
    
    <h3>Exemple Concret</h3>
    <div class="algorithm-box" style="background:rgba(59,130,246,0.08); border-color:#3b82f6;">
        <b>Patient #{top['id']}:</b><br>
        Cr√©at={top['sc']} | Age={top['age']} | Score=<span style="color:#ef4444">{top['score']}</span>/100<br><br>
        ‚Üí <span style="color:#ef4444;font-weight:bold;">CRITIQUE - PRIORIT√â IMM√âDIATE</span>
    </div>
  </div>
</div>

<!-- MODAL: MATCHING -->
<div id="matchingModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('matching')">&times;</span>
    <h2 style="color: #00d2ff; margin-top:0;">üîó Algorithme de Matching (Stable Matching)</h2>
    
    <h3>Contexte: Jeu de Coalition</h3>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
        L'√©change r√©nal est un <b>jeu de coalition</b> o√π:
        <br>‚Ä¢ Chaque patient veut un rein compatible<br>
        ‚Ä¢ Chaque donneur veut aider un patient urgent<br>
        ‚Ä¢ Les ressources sont limit√©es (compatibilit√© ABO)
    </p>
    
    <h3>Th√©orie des Jeux: Stable Matching</h3>
    <p style="font-size:12px; line-height:1.7; color:#e4e4e7;">
        Un matching est <b>stable</b> si:<br>
        ‚úì Aucun couple Donneur-Patient ne peut se d√©vier<br>
        ‚úì Aucun cycle ne peut abandonner pour un meilleur cycle<br>
        ‚úì L'allocation est <b>Pareto optimale</b> (max surplus)
    </p>
    
    <h3>Algorithme Gale-Shapley (Adapt√©)</h3>
    <div class="algorithm-box" style="background:rgba(0,210,255,0.08); border-color:#00d2ff;">
        <b>√âTAPE 1: Construire Graphe ABO</b><br>
        Pour chaque donneur i et patient j:<br>
        ‚Ä¢ Si groupe(j) ‚àà compatibles(groupe(i))<br>
        ‚Ä¢ Ajouter ar√™te i ‚Üí j<br>
        ‚Ä¢ Poids = urgence(j)<br><br>
        
        <b>√âTAPE 2: D√©tecter Tous les Cycles</b><br>
        Algorithme rapide: <code>nx.simple_cycles()</code><br>
        Limite: longueur ‚â§ 3 (viabilit√© m√©dicale)<br><br>
        
        <b>√âTAPE 3: √âvaluer Utilit√© Sociale</b><br>
        Pour chaque cycle C:<br>
        <code>utilit√©(C) = Œ£ urgence(n) + bonus[max urgence &gt; 80]</code><br><br>
        
        <b>√âTAPE 4: S√©lection Greedy</b><br>
        Trier cycles par utilit√© (d√©croissant)<br>
        S√©lectionner cycles disjoints (max urgence)<br>
        R√©sultat = Stable matching<br><br>
        
        <b>√âTAPE 5: Validation Nash</b><br>
        V√©rifier: Aucune coalition ne peut d√©vier
    </div>
    
    <h3>R√©sultat: Core Solution</h3>
    <p style="font-size:12px; line-height:1.7; color:#a1a1aa;">
        <b>{n_cyc} cycles</b> d'√©change d√©tect√©s<br>
        <b>{n_sav} patients</b> sauv√©s par ces cycles<br>
        <b>Efficacit√© Pareto:</b> {success_rate}%
    </p>
  </div>
</div>

<script>
    const nodesRaw = {nodes};
    const edgesRaw = {edges};
    
    const nodes = new vis.DataSet(nodesRaw);
    const edges = new vis.DataSet(edgesRaw);
    
    const container = document.getElementById('network');
    const data = {{ nodes: nodes, edges: edges }};
    const options = {{
        nodes: {{ 
            shape: 'dot', 
            font: {{ color: '#fff', face: 'Inter', size: 10 }}, 
            borderWidth: 2,
            shadow: true 
        }},
        edges: {{ 
            smooth: {{ type: 'continuous' }}, 
            arrows: {{ to: {{ scaleFactor: 0.5 }} }},
            font: {{ size: 10 }},
            shadow: true
        }},
        physics: {{ 
            stabilization: {{ iterations: 1000 }}, 
            barnesHut: {{ gravitationalConstant: -2000 }} 
        }}
    }};
    
    const network = new vis.Network(container, data, options);
    
    network.once("stabilizationIterationsDone", function() {{
        network.setOptions({{ physics: {{ enabled: false }} }});
        network.fit();
    }});

    function openModal(modalId) {{ 
        document.getElementById(modalId + 'Modal').style.display = "block"; 
    }}
    function closeModal(modalId) {{ 
        document.getElementById(modalId + 'Modal').style.display = "none"; 
    }}
    window.onclick = function(event) {{ 
        if (event.target.classList.contains('modal')) {{ 
            event.target.style.display = "none"; 
        }} 
    }}

    // Charts
    var urgencyScores = {nodes}.map(n => n.val);
    var ctx = document.getElementById('scoreChart');
    if(ctx) {{
        new Chart(ctx, {{
            type: 'bar',
            data: {{
                labels: urgencyScores.slice(0, 20).map((_, i) => 'P' + i),
                datasets: [{{
                    label: 'Score Urgence',
                    data: urgencyScores.slice(0, 20),
                    backgroundColor: urgencyScores.slice(0, 20).map(s => 
                        s > 80 ? '#ef4444' : s > 50 ? '#eab308' : '#22c55e'
                    ),
                    borderColor: '#333',
                    borderWidth: 1
                }}]
            }},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                scales: {{ y: {{ max: 100, ticks: {{ color: '#888' }}, grid: {{ color: '#222' }} }},
                          x: {{ ticks: {{ color: '#888' }}, grid: {{ display: false }} }} }},
                plugins: {{ legend: {{ display: false }} }}
            }}
        }});
    }}
    
    var histCtx = document.getElementById('histChart');
    if(histCtx) {{
        var bins = [0,0,0,0,0];
        urgencyScores.forEach(s => {{
            if(s < 20) bins[0]++;
            else if(s < 40) bins[1]++;
            else if(s < 60) bins[2]++;
            else if(s < 80) bins[3]++;
            else bins[4]++;
        }});
        new Chart(histCtx, {{
            type: 'doughnut',
            data: {{
                labels: ['<20 (Stable)', '20-40', '40-60', '60-80 (Grave)', '80+ (Critique)'],
                datasets: [{{
                    data: bins,
                    backgroundColor: ['#22c55e', '#84cc16', '#eab308', '#f97316', '#ef4444'],
                    borderColor: '#000',
                    borderWidth: 2
                }}]
            }},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                plugins: {{ legend: {{ position: 'bottom', labels: {{ color: '#a1a1aa', font: {{ size: 10 }} }} }} }}
            }}
        }});
    }}

    function setStep(step) {{
        document.querySelectorAll('.btn').forEach((b, i) => b.classList.toggle('active', i === step-1));
        document.querySelectorAll('.story-text').forEach((d, i) => d.classList.toggle('active', i === step-1));
        
        const allNodes = nodes.get();
        const allEdges = edges.get();
        const legend = document.getElementById('legend');
        
        if(step === 1) {{
            allNodes.forEach(n => {{ n.color = '#3f3f46'; n.size = 8; n.shadow = false; }});
            allEdges.forEach(e => {{ e.hidden = false; e.color = {{color:'#333', opacity: 0.1}}; e.width=0.5; }});
            legend.innerHTML = '<b>Step 1: Donn√©es</b><br><span class="dot" style="background:#3f3f46"></span>Paire (Patient + Donneur)';
        }}
        
        if(step === 2) {{
            allNodes.forEach(n => {{ n.color = n.ai_color; n.size = 5 + (n.val/8); n.shadow = true; }});
            allEdges.forEach(e => {{ e.hidden = true; }});
            legend.innerHTML = '<b>Step 2: Urgence</b><br><span class="dot" style="background:#ef4444"></span>Critique<br><span class="dot" style="background:#eab308"></span>Grave<br><span class="dot" style="background:#22c55e"></span>Stable';
        }}
        
        if(step === 3) {{
            // Matching view: show only cycle edges (candidates + validated)
            allNodes.forEach(n => {{ 
                if(n.cid > -1) {{
                    n.hidden = false;
                    n.color = '#00d2ff';
                    n.size = 16;
                    // keep label for validated nodes
                }} else if(n.in_any_cycle) {{
                    n.hidden = false;
                    n.color = '#93c5fd';
                    n.size = 6;
                    n.label = '';
                }} else {{
                    // hide irrelevant nodes to reduce clutter
                    n.hidden = true;
                }}
            }});
            allEdges.forEach(e => {{
                if(e.is_sol) {{ e.hidden = false; e.color = {{color:'#00d2ff', opacity:0.95}}; e.width=2; }}
                else if(e.is_candidate) {{ e.hidden = false; e.color = {{color:'#93c5fd', opacity:0.4}}; e.width=1; }}
                else {{ e.hidden = true; }}
            }});
            legend.innerHTML = '<b>Step 3: Matching</b><br><span class="dot" style="background:#00d2ff"></span>Cycle valid√© &nbsp; <span class="dot" style="background:#93c5fd"></span>Cycle candidat';
        }}
        
        if(step === 4) {{
            allNodes.forEach(n => {{ n.color = '#3b82f6'; n.size = 10; n.shadow = true; }});
            allEdges.forEach(e => {{ e.hidden = true; }});
            legend.innerHTML = '<b>Step 4: Analyse</b><br>Voir les statistiques ‚Üí';
        }}
        
        nodes.update(allNodes);
        edges.update(allEdges);
    }}
    
    function applyPatientCount() {{
        let n = parseInt(document.getElementById('patientCountInput').value) || nodesRaw.length;
        n = Math.max(2, Math.min(nodesRaw.length, n));
        // take first n patients from the original nodesRaw order
        const filteredNodes = nodesRaw.slice(0, n).map(n => Object.assign({{hidden:false}}, n));
        const ids = new Set(filteredNodes.map(x => x.id));
        const filteredEdges = edgesRaw.filter(e => ids.has(e.from) && ids.has(e.to));

        // replace datasets
        nodes.clear();
        edges.clear();
        nodes.add(filteredNodes);
        edges.add(filteredEdges);

        // update small stats in sidebar if present
        const totalSpan = document.getElementById('displayTotal');
        if(totalSpan) totalSpan.innerText = String(n);

        // reapply current view styles
        setStep(currentView);
    }}
    
    setStep(1);
</script>

</body>
</html>"""
        return html
    
    def generate(self):
        """G√©n√®re le HTML et l'√©crit dans un fichier"""
        html = self.build_html()
        
        output_file = "kidney_hybrid_dashboard.html"
        with open(output_file, "w", encoding="utf-8") as f:
            f.write(html)
        print(f"‚úÖ Site g√©n√©r√© : {output_file}")
        
        # CORRECTIF #8: Gestion d'erreur pour webbrowser
        try:
            webbrowser.open(output_file)
        except Exception as e:
            print(f"Impossible d'ouvrir le navigateur automatiquement: {e}")
            print(f"Ouvrez manuellement le fichier: {os.path.abspath(output_file)}")

if __name__ == "__main__":
    print(f"üîß Nombre de patients: {NOMBRE_PATIENTS}")
    print(f"   (Pour changer: modifie NOMBRE_PATIENTS en ligne 6)\n")
    
    try:
        eng = MedicalEngine()  # Utilise NOMBRE_PATIENTS par d√©faut
        success = eng.load_and_merge()
        if success:
            eng.run_ai_scoring()
            eng.run_game_theory()
            data = eng.export()
            WebRenderer(*data).generate()
            print("\nüåê Ouverture du navigateur...")
        else:
            print("√âchec du chargement des donn√©es")
    except Exception as e:
        print(f"ERREUR FATALE: {e}")
        import traceback
        traceback.print_exc()